import pkg_resources

import numpy.typing as npt
import numpy as np

from .loaders import _load_energy_logfile, _load_transition_logfile, _load_obtd
from .onebody_transition_density_tools import make_level_dict

def test_load_energy_logfile():
    levels: npt.NDArray = _load_energy_logfile(
        path = pkg_resources.resource_filename('kshell_utilities', 'test_files/log_V50_GCLSTsdpfsdgix5pn_j0p.txt')
    )
    expected_energies = [
        -392.15904, -391.87918, -391.28807, -391.17057, -390.44002, -390.06541,
        -389.86772, -389.83919, -389.31714, -389.06729, -388.784,   -388.59289,
        -388.57039, -388.40539, -388.1968,  -388.14303, -388.04195, -387.77982,
        -387.63565, -387.56545, -387.45116, -387.43385, -387.30063, -387.2544,
        -387.02201, -386.85552, -386.79288, -386.6574,  -386.64041, -386.62891,
        -386.51819, -386.50306, -386.45511, -386.41216, -386.31734, -386.26407,
        -386.21622, -386.12929, -386.11792, -385.96679, -385.92837, -385.86811,
        -385.77466, -385.72648, -385.66697, -385.55887, -385.53943, -385.46135,
        -385.45629, -385.44488, -385.39907, -385.34762, -385.33419, -385.27385,
        -385.23275, -385.14203, -385.08344, -385.01235, -385.00448, -384.96783,
        -384.93757, -384.92071, -384.88362, -384.85641, -384.8322,  -384.81149,
        -384.76652, -384.73499, -384.69545, -384.66275, -384.58908, -384.5749,
        -384.52536, -384.49007, -384.47427, -384.4308,  -384.39995, -384.37118,
        -384.35701, -384.32791, -384.2911,  -384.24597, -384.19671, -384.16197,
        -384.11927, -384.10432, -384.04675, -384.0059,  -383.9646,  -383.94497,
        -383.90206, -383.86877, -383.86056, -383.84362, -383.79145, -383.76175,
        -383.74647, -383.73498, -383.72184, -383.68725, -383.65797, -383.61139,
        -383.57793, -383.5467,  -383.52865, -383.50943, -383.47704, -383.44997,
        -383.43918, -383.42165, -383.41613, -383.37586, -383.35723, -383.32565,
        -383.29181, -383.26639, -383.25484, -383.24069, -383.23991, -383.22365,
        -383.20163, -383.1693,  -383.15186, -383.131,   -383.11096, -383.10213,
        -383.05318, -383.03786, -382.99332, -382.97311, -382.95468, -382.93878,
        -382.93625, -382.91026, -382.90846, -382.88592, -382.85452, -382.82076,
        -382.8078,  -382.7849,  -382.78209, -382.73696, -382.73514, -382.71719,
        -382.69036, -382.66774, -382.65989, -382.64508, -382.62155, -382.61111,
        -382.60313, -382.59006, -382.57579, -382.56519, -382.51692, -382.48697,
        -382.48151, -382.45994, -382.44407, -382.41855, -382.40847, -382.39294,
        -382.38223, -382.37415, -382.35276, -382.3342,  -382.32167, -382.3005,
        -382.28363, -382.2664,  -382.2642,  -382.24416, -382.21746, -382.18673,
        -382.18035, -382.15111, -382.14444, -382.12779, -382.12307, -382.09488,
        -382.07123, -382.06352, -382.04711, -382.04102, -381.99469, -381.98959,
        -381.98293, -381.95451, -381.94813, -381.93173, -381.92391, -381.91682,
        -381.89859, -381.87117, -381.8568,  -381.85164, -381.82438, -381.82337,
        -381.79418, -381.77844,
    ]
    expected_indices = [
        0,   1,   2,   3,   4,   5,   6,   7,   8,   9,  10,  11,  12,  13,
        14,  15,  16,  17,  18,  19,  20,  21,  22,  23,  24,  25,  26,  27,
        28,  29,  30,  31,  32,  33,  34,  35,  36,  37,  38,  39,  40,  41,
        42,  43,  44,  45,  46,  47,  48,  49,  50,  51,  52,  53,  54,  55,
        56,  57,  58,  59,  60,  61,  62,  63,  64,  65,  66,  67,  68,  69,
        70,  71,  72,  73,  74,  75,  76,  77,  78,  79,  80,  81,  82,  83,
        84,  85,  86,  87,  88,  89,  90,  91,  92,  93,  94,  95,  96,  97,
        98,  99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111,
        112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125,
        126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139,
        140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153,
        154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167,
        168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181,
        182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195,
        196, 197, 198, 199,
    ]
    expected_parities = [1]*len(expected_energies)
    expected_j = [0]*len(expected_energies)
    expected_Hcm = [0]*len(expected_energies)

    assert np.all(expected_energies == levels[:, 0])
    assert np.all(expected_j == levels[:, 1])
    assert np.all(expected_parities == levels[:, 2])
    assert np.all(expected_indices == levels[:, 3])
    assert np.all(expected_Hcm == levels[:, 4])

def test_load_transition_logfile():
    transitions_E1, transitions_M1, transitions_E2 = _load_transition_logfile(
        path = pkg_resources.resource_filename('kshell_utilities', 'test_files/log_V50_GCLSTsdpfsdgix5pn_tr_j2n_j2n.txt')
    )
    expected_transitions_E2 = [ # NOTE: Negative Egamma will be skipped when initial and final j and parity are the same.
        [2, -1, 1, -391.739, 2, -1, 0, -392.049, 0.31,  2.040871989205121, 2.040871989205121, -2.47439204],
        [2, -1, 2, -391.501, 2, -1, 0, -392.049, 0.548, 3.479285437634594, 3.479285437634594, -3.23076714],
        [2, -1, 3, -391.421, 2, -1, 0, -392.049, 0.628, 22.833261280496853, 22.833261280496853, -8.27645962],
        [2, -1, 4, -391.405, 2, -1, 0, -392.049, 0.644, 23.93839122374008, 23.93839122374008, 8.47438338],
        [2, -1, 5, -391.138, 2, -1, 0, -392.049, 0.911, 1.9930707021425205, 1.9930707021425205, 2.44524275],
    ]

    assert len(expected_transitions_E2) == len(transitions_E2)
    for expected, calculated in zip(expected_transitions_E2, transitions_E2, strict=True):
        assert expected == calculated, f"{expected = }, {calculated = }"

    assert not transitions_E1
    assert not transitions_M1

    transitions_E1, transitions_M1, transitions_E2 = _load_transition_logfile(
        path = pkg_resources.resource_filename('kshell_utilities', 'test_files/log_V50_GCLSTsdpfsdgix5pn_tr_j2p_j4n.txt')
    )

    expected_transitions_E1 = [
        [4, -1,   0, -392.585, 2, +1,   0, -393.605,  1.02, 3.2282862339200006e-06,  5.3804770565333345e-06,  0.00401764],
        [2, +1, 199, -384.604, 4, -1, 179,  -387.12, 2.516, 1.4440753199999999e-08,          8.66445192e-09, -0.00020814],
        [2, +1, 199, -384.604, 4, -1, 180, -387.096, 2.492, 1.9196122563333337e-07,  1.1517673538000001e-07, -0.00075887],
        [2, +1, 199, -384.604, 4, -1, 181, -387.087, 2.483, 1.1234261756033335e-05,   6.740557053620001e-06, -0.00580541],
        [2, +1, 199, -384.604, 4, -1, 182, -387.072, 2.468, 5.7671467499999996e-08,          3.46028805e-08,  0.00041595],
        [2, +1, 199, -384.604, 4, -1, 183,  -387.06, 2.456,  8.242416000333332e-07,        4.9454496002e-07, -0.00157249],
        [2, +1, 199, -384.604, 4, -1, 184, -387.056, 2.452,  9.164539781333332e-07,   5.498723868799999e-07,  0.00165812],
    ]
    expected_transitions_M1 = [
        [4, -1, 0, -392.585, 2, 1, 0, -393.605, 1.02, 3.2282862339200006e-06, 5.3804770565333345e-06, 0.00401764],
        [4, -1, 1, -392.297, 2, 1, 0, -393.605, 1.308, 4.8472587072020005e-05, 8.078764512003333e-05, -0.01556801]
    ]
    expected_transitions_E2 = [
        [2, 1, 199, -384.604, 4, -1, 190, -387.016, 2.412, 1.6003502256333332e-06, 9.6021013538e-07, -0.00219113],
        [2, 1, 199, -384.604, 4, -1, 191,  -387.01, 2.406, 1.5750630208333333e-06,  9.450378125e-07, -0.00217375],
        [2, 1, 199, -384.604, 4, -1, 192, -387.005, 2.401, 6.295036163333334e-06,  3.777021698e-06,  0.00434570],
    ]
    assert len(expected_transitions_E2) == len(transitions_E2)
    assert len(expected_transitions_E1) == len(transitions_E1)
    assert len(expected_transitions_M1) == len(transitions_M1)
    
    for expected, calculated in zip(expected_transitions_E1, transitions_E1, strict=True):
        assert expected == calculated, f"{expected = }, {calculated = }"

    for expected, calculated in zip(expected_transitions_M1, transitions_M1, strict=True):
        assert expected == calculated, f"{expected = }, {calculated = }"

    for expected, calculated in zip(expected_transitions_E2, transitions_E2, strict=True):
        assert expected == calculated, f"{expected = }, {calculated = }"

def test_load_obtd():
    levels = np.concatenate([
        _load_energy_logfile(
            path = pkg_resources.resource_filename('kshell_utilities', 'test_files/obtd_test/log_V50_GCLSTsdpfsdgix5pn_j6n.txt'),
        ),
        _load_energy_logfile(
            path = pkg_resources.resource_filename('kshell_utilities', 'test_files/obtd_test/log_V50_GCLSTsdpfsdgix5pn_j4p.txt'),
        ),
        _load_energy_logfile(
            path = pkg_resources.resource_filename('kshell_utilities', 'test_files/obtd_test/log_V50_GCLSTsdpfsdgix5pn_j2p.txt'),
        ),
    ])
    level_dict = make_level_dict(levels=levels)
    obtd_dict: dict[tuple[int, ...], npt.NDArray] = {}
    
    # ------------------- LOAD THE L FILE (diag)
    _load_obtd(
        path = pkg_resources.resource_filename('kshell_utilities', 'test_files/obtd_test/OBTD_L_V50_GCLSTsdpfsdgix5pn_j6n_V50_GCLSTsdpfsdgix5pn_j6n.txt'),
        obtd_dict = obtd_dict,
        level_dict = level_dict,
    )

    expected_keys = [
        (6, -1, 6, -1),         # Master key.
        (6, -1, 1, 6, -1, 0),
        (6, -1, 1, 6, -1, 0, 0),    # With transit idx.
    ]

    assert expected_keys == list(obtd_dict.keys())
    assert obtd_dict[expected_keys[0]].shape == (92, 5, 1)
    assert obtd_dict[expected_keys[1]].shape == (92, 5)
    assert obtd_dict[expected_keys[2]].shape == (92, 5)
    assert np.all(obtd_dict[expected_keys[1]] == obtd_dict[expected_keys[2]])

    expected = np.array(    # i j OBTD L S
        [   
            [1,  1,    -0.00267,     5.79655,    np.inf],
            [1,  2,     0.02403,     1.54919,    np.inf],
            [1,  9,     0.00000,     0.00000,    np.inf],
            [1, 10,     0.00000,     0.00000,    np.inf],
            [1, 11,     0.00000,     0.00000,    np.inf],
            [2,  1,    -0.00902,    -1.54919,    np.inf],
            [2,  2,     0.04604,     4.64758,    np.inf],
            [2,  3,     0.07029,     0.00000,    np.inf],
            [2, 10,     0.00000,     0.00000,    np.inf],
            [2, 11,     0.00000,     0.00000,    np.inf],
            [2, 12,     0.00000,     0.00000,    np.inf],
            [3,  2,    -0.11878,     0.00000,    np.inf],
            [3,  3,    -0.16939,     0.00000,    np.inf],
            [3, 11,     0.00000,     0.00000,    np.inf],
            [3, 12,     0.00000,     0.00000,    np.inf],
            [4,  4,    -0.23428,     9.62140,    np.inf],
            [4,  5,    -0.09284,     1.85164,    np.inf],
            [5,  4,     0.09217,    -1.85164,    np.inf],
            [5,  5,    -0.02646,     8.28079,    np.inf],
            [5,  6,     0.02370,     0.00000,    np.inf],
            [6,  5,    -0.01852,     0.00000,    np.inf],
            [6,  6,    -0.00215,     2.58199,    np.inf],
            [6,  7,    -0.00142,     1.15470,    np.inf],
            [7,  6,     0.00299,    -1.15470,    np.inf],
            [7,  7,     0.00176,     1.63299,    np.inf],
            [8,  8,    -0.00074,    13.98412,    np.inf],
            [8,  9,     0.00012,     2.10819,    np.inf],
            [9,  1,     0.00000,     0.00000,    np.inf],
            [9,  8,    -0.00034,    -2.10819,    np.inf],
            [9,  9,    -0.00011,    12.47219,    np.inf],
            [9, 10,     0.00001,     0.00000,    np.inf],
            [10,  1,     0.00000,     0.00000,    np.inf],
            [10,  2,     0.00000,     0.00000,    np.inf],
            [10,  9,     0.00007,     0.00000,    np.inf],
            [10, 10,    -0.00004,     5.79655,    np.inf],
            [10, 11,     0.00002,     1.54919,    np.inf],
            [11,  1,     0.00000,     0.00000,    np.inf],
            [11,  2,     0.00000,     0.00000,    np.inf],
            [11,  3,     0.00000,     0.00000,    np.inf],
            [11, 10,    -0.00001,    -1.54919,    np.inf],
            [11, 11,     0.00003,     4.64758,    np.inf],
            [11, 12,    -0.00004,     0.00000,    np.inf],
            [12,  2,     0.00000,     0.00000,    np.inf],
            [12,  3,     0.00000,     0.00000,    np.inf],
            [12, 11,     0.00005,     0.00000,    np.inf],
            [12, 12,    -0.00006,     0.00000,    np.inf],
            [13, 13,    -0.00325,     5.79655,    np.inf],
            [13, 14,     0.01651,     1.54919,    np.inf],
            [13, 21,     0.00000,     0.00000,    np.inf],
            [13, 22,     0.00000,     0.00000,    np.inf],
            [13, 23,     0.00000,     0.00000,    np.inf],
            [14, 13,    -0.01367,    -1.54919,    np.inf],
            [14, 14,    -0.08668,     4.64758,    np.inf],
            [14, 15,    -0.11733,     0.00000,    np.inf],
            [14, 22,     0.00000,     0.00000,    np.inf],
            [14, 23,     0.00000,     0.00000,    np.inf],
            [14, 24,     0.00000,     0.00000,    np.inf],
            [15, 14,     0.11601,     0.00000,    np.inf],
            [15, 15,    -0.01497,     0.00000,    np.inf],
            [15, 23,     0.00000,     0.00000,    np.inf],
            [15, 24,     0.00000,     0.00000,    np.inf],
            [16, 16,     0.27571,     9.62140,    np.inf],
            [16, 17,     0.01264,     1.85164,    np.inf],
            [17, 16,    -0.02297,    -1.85164,    np.inf],
            [17, 17,    -0.01808,     8.28079,    np.inf],
            [17, 18,    -0.03018,     0.00000,    np.inf],
            [18, 17,     0.02687,     0.00000,    np.inf],
            [18, 18,     0.07306,     2.58199,    np.inf],
            [18, 19,     0.00403,     1.15470,    np.inf],
            [19, 18,     0.00245,    -1.15470,    np.inf],
            [19, 19,    -0.00709,     1.63299,    np.inf],
            [20, 20,     0.00270,    13.98412,    np.inf],
            [20, 21,     0.00004,     2.10819,    np.inf],
            [21, 13,     0.00000,     0.00000,    np.inf],
            [21, 20,     0.00046,    -2.10819,    np.inf],
            [21, 21,    -0.00114,    12.47219,    np.inf],
            [21, 22,    -0.00015,     0.00000,    np.inf],
            [22, 13,     0.00000,     0.00000,    np.inf],
            [22, 14,     0.00000,     0.00000,    np.inf],
            [22, 21,     0.00016,     0.00000,    np.inf],
            [22, 22,    -0.00013,     5.79655,    np.inf],
            [22, 23,    -0.00005,     1.54919,    np.inf],
            [23, 13,     0.00000,     0.00000,    np.inf],
            [23, 14,     0.00000,     0.00000,    np.inf],
            [23, 15,     0.00000,     0.00000,    np.inf],
            [23, 22,     0.00004,    -1.54919,    np.inf],
            [23, 23,    -0.00001,     4.64758,    np.inf],
            [23, 24,    -0.00002,     0.00000,    np.inf],
            [24, 14,     0.00000,     0.00000,    np.inf],
            [24, 15,     0.00000,     0.00000,    np.inf],
            [24, 23,     0.00005,     0.00000,    np.inf],
            [24, 24,     0.00003,     0.00000,    np.inf],
        ],
        dtype = np.float32
    )

    expected[:, 0] -= 1
    expected[:, 1] -= 1
    assert np.all(expected == obtd_dict[(expected_keys[1])])

    # ------------------- LOAD THE S FILE (diag)
    _load_obtd(
        path = pkg_resources.resource_filename('kshell_utilities', 'test_files/obtd_test/OBTD_S_V50_GCLSTsdpfsdgix5pn_j6n_V50_GCLSTsdpfsdgix5pn_j6n.txt'),
        obtd_dict = obtd_dict,
        level_dict = level_dict,
    )
    expected_S = np.array(
        [
            1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,-0.77460,
            0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 1.22474, 0.00000,
            0.00000, 1.60357,-1.85164, 1.85164,-1.03510, 0.00000, 0.00000,
            1.29099,-1.15470, 1.15470,-0.40825, 1.74801,-2.10819, 0.00000,
            2.10819,-1.24722, 0.00000, 0.00000, 0.00000, 0.00000, 1.44914,
            -1.54919, 0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000,
            0.00000, 0.00000, 0.00000, 1.22474, 1.44914,-1.54919, 0.00000,
            0.00000, 0.00000, 1.54919,-0.77460, 0.00000, 0.00000, 0.00000,
            0.00000, 0.00000, 1.22474, 0.00000, 0.00000, 1.60357,-1.85164,
            1.85164,-1.03510, 0.00000, 0.00000, 1.29099,-1.15470, 1.15470,
            -0.40825, 1.74801,-2.10819, 0.00000, 2.10819,-1.24722, 0.00000,
            0.00000, 0.00000, 0.00000, 1.44914,-1.54919, 0.00000, 0.00000,
            0.00000, 1.54919,-0.77460, 0.00000, 0.00000, 0.00000, 0.00000,
            1.22474,
        ],
        dtype = np.float32,
    )

    expected[:, 4] = expected_S

    assert expected_keys == list(obtd_dict.keys())
    assert obtd_dict[expected_keys[0]].shape == (92, 5, 1)
    assert obtd_dict[expected_keys[1]].shape == (92, 5)
    assert obtd_dict[expected_keys[2]].shape == (92, 5)
    assert np.all(obtd_dict[expected_keys[1]] == obtd_dict[expected_keys[2]])
    assert np.all(expected == obtd_dict[(expected_keys[1])])

    # ------------------LOAD THE NON-DIAG FILES
    _load_obtd(
        path = pkg_resources.resource_filename('kshell_utilities', 'test_files/obtd_test/OBTD_L_V50_GCLSTsdpfsdgix5pn_j2p_V50_GCLSTsdpfsdgix5pn_j4p.txt'),
        obtd_dict = obtd_dict,
        level_dict = level_dict,
    )
    expected_keys.extend(
        [
            (4, +1, 2, +1),             # Master key.
            (2, +1, 4, +1),             # Master key.
            (2, +1, 0, 4, +1, 0),
            (2, +1, 0, 4, +1, 0, 0),    # With transit idx.
            (2, +1, 0, 4, +1, 1),
            (2, +1, 0, 4, +1, 1, 1),
            (4, +1, 2, 2, +1, 0),
            (4, +1, 2, 2, +1, 0, 0),
        ]
    )

    expected_210410 = np.array(
        [
            [1,  1,     0.00000,     5.79655,    np.inf],
            [1,  2,     0.00000,     1.54919,    np.inf],
            [1,  9,     0.00000,     0.00000,    np.inf],
            [1, 10,     0.00000,     0.00000,    np.inf],
            [1, 11,     0.00000,     0.00000,    np.inf],
            [2,  1,     0.00000,    -1.54919,    np.inf],
            [2,  2,     0.00000,     4.64758,    np.inf],
            [2,  3,     0.00000,     0.00000,    np.inf],
            [2, 10,     0.00000,     0.00000,    np.inf],
            [2, 11,     0.00000,     0.00000,    np.inf],
            [2, 12,     0.00000,     0.00000,    np.inf],
            [3,  2,     0.00000,     0.00000,    np.inf],
            [3,  3,     0.00000,     0.00000,    np.inf],
            [3, 11,     0.00000,     0.00000,    np.inf],
            [3, 12,     0.00000,     0.00000,    np.inf],
            [4,  4,    -0.29263,     9.62140,    np.inf],
            [4,  5,    -0.03556,     1.85164,    np.inf],
            [5,  4,     0.02537,    -1.85164,    np.inf],
            [5,  5,    -0.01304,     8.28079,    np.inf],
            [5,  6,    -0.00274,     0.00000,    np.inf],
            [6,  5,    -0.00648,     0.00000,    np.inf],
            [6,  6,    -0.00996,     2.58199,    np.inf],
            [6,  7,     0.00554,     1.15470,    np.inf],
            [7,  6,     0.00932,    -1.15470,    np.inf],
            [7,  7,    -0.00153,     1.63299,    np.inf],
            [8,  8,     0.00000,    13.98412,    np.inf],
            [8,  9,     0.00000,     2.10819,    np.inf],
            [9,  1,     0.00000,     0.00000,    np.inf],
            [9,  8,     0.00000,    -2.10819,    np.inf],
            [9,  9,     0.00000,    12.47219,    np.inf],
            [9, 10,     0.00000,     0.00000,    np.inf],
            [10,  1,     0.00000,     0.00000,    np.inf],
            [10,  2,     0.00000,     0.00000,    np.inf],
            [10,  9,     0.00000,     0.00000,    np.inf],
            [10, 10,     0.00000,     5.79655,    np.inf],
            [10, 11,     0.00000,     1.54919,    np.inf],
            [11,  1,     0.00000,     0.00000,    np.inf],
            [11,  2,     0.00000,     0.00000,    np.inf],
            [11,  3,     0.00000,     0.00000,    np.inf],
            [11, 10,     0.00000,    -1.54919,    np.inf],
            [11, 11,     0.00000,     4.64758,    np.inf],
            [11, 12,     0.00000,     0.00000,    np.inf],
            [12,  2,     0.00000,     0.00000,    np.inf],
            [12,  3,     0.00000,     0.00000,    np.inf],
            [12, 11,     0.00000,     0.00000,    np.inf],
            [12, 12,     0.00000,     0.00000,    np.inf],
            [13, 13,     0.00000,     5.79655,    np.inf],
            [13, 14,     0.00000,     1.54919,    np.inf],
            [13, 21,     0.00000,     0.00000,    np.inf],
            [13, 22,     0.00000,     0.00000,    np.inf],
            [13, 23,     0.00000,     0.00000,    np.inf],
            [14, 13,     0.00000,    -1.54919,    np.inf],
            [14, 14,     0.00000,     4.64758,    np.inf],
            [14, 15,     0.00000,     0.00000,    np.inf],
            [14, 22,     0.00000,     0.00000,    np.inf],
            [14, 23,     0.00000,     0.00000,    np.inf],
            [14, 24,     0.00000,     0.00000,    np.inf],
            [15, 14,     0.00000,     0.00000,    np.inf],
            [15, 15,     0.00000,     0.00000,    np.inf],
            [15, 23,     0.00000,     0.00000,    np.inf],
            [15, 24,     0.00000,     0.00000,    np.inf],
            [16, 16,     0.29820,     9.62140,    np.inf],
            [16, 17,     0.06385,     1.85164,    np.inf],
            [17, 16,    -0.06056,    -1.85164,    np.inf],
            [17, 17,     0.00236,     8.28079,    np.inf],
            [17, 18,    -0.00315,     0.00000,    np.inf],
            [18, 17,     0.00243,     0.00000,    np.inf],
            [18, 18,     0.01550,     2.58199,    np.inf],
            [18, 19,    -0.00112,     1.15470,    np.inf],
            [19, 18,    -0.00172,    -1.15470,    np.inf],
            [19, 19,    -0.00386,     1.63299,    np.inf],
            [20, 20,     0.00000,    13.98412,    np.inf],
            [20, 21,     0.00000,     2.10819,    np.inf],
            [21, 13,     0.00000,     0.00000,    np.inf],
            [21, 20,     0.00000,    -2.10819,    np.inf],
            [21, 21,     0.00000,    12.47219,    np.inf],
            [21, 22,     0.00000,     0.00000,    np.inf],
            [22, 13,     0.00000,     0.00000,    np.inf],
            [22, 14,     0.00000,     0.00000,    np.inf],
            [22, 21,     0.00000,     0.00000,    np.inf],
            [22, 22,     0.00000,     5.79655,    np.inf],
            [22, 23,     0.00000,     1.54919,    np.inf],
            [23, 13,     0.00000,     0.00000,    np.inf],
            [23, 14,     0.00000,     0.00000,    np.inf],
            [23, 15,     0.00000,     0.00000,    np.inf],
            [23, 22,     0.00000,    -1.54919,    np.inf],
            [23, 23,     0.00000,     4.64758,    np.inf],
            [23, 24,     0.00000,     0.00000,    np.inf],
            [24, 14,     0.00000,     0.00000,    np.inf],
            [24, 15,     0.00000,     0.00000,    np.inf],
            [24, 23,     0.00000,     0.00000,    np.inf],
            [24, 24,     0.00000,     0.00000,    np.inf],
        ],
        dtype = np.float32,
    )
    expected_210411 = np.array(
        [
            [1,  1,     0.00000,     5.79655,    np.inf],
            [1,  2,     0.00000,     1.54919,    np.inf],
            [1,  9,     0.00000,     0.00000,    np.inf],
            [1, 10,     0.00000,     0.00000,    np.inf],
            [1, 11,     0.00000,     0.00000,    np.inf],
            [2,  1,     0.00000,    -1.54919,    np.inf],
            [2,  2,     0.00000,     4.64758,    np.inf],
            [2,  3,     0.00000,     0.00000,    np.inf],
            [2, 10,     0.00000,     0.00000,    np.inf],
            [2, 11,     0.00000,     0.00000,    np.inf],
            [2, 12,     0.00000,     0.00000,    np.inf],
            [3,  2,     0.00000,     0.00000,    np.inf],
            [3,  3,     0.00000,     0.00000,    np.inf],
            [3, 11,     0.00000,     0.00000,    np.inf],
            [3, 12,     0.00000,     0.00000,    np.inf],
            [4,  4,    -0.20240,     9.62140,    np.inf],
            [4,  5,    -0.00378,     1.85164,    np.inf],
            [5,  4,    -0.01468,    -1.85164,    np.inf],
            [5,  5,    -0.00719,     8.28079,    np.inf],
            [5,  6,     0.01936,     0.00000,    np.inf],
            [6,  5,    -0.02645,     0.00000,    np.inf],
            [6,  6,     0.01836,     2.58199,    np.inf],
            [6,  7,    -0.00626,     1.15470,    np.inf],
            [7,  6,    -0.00268,    -1.15470,    np.inf],
            [7,  7,     0.00428,     1.63299,    np.inf],
            [8,  8,     0.00000,    13.98412,    np.inf],
            [8,  9,     0.00000,     2.10819,    np.inf],
            [9,  1,     0.00000,     0.00000,    np.inf],
            [9,  8,     0.00000,    -2.10819,    np.inf],
            [9,  9,     0.00000,    12.47219,    np.inf],
            [9, 10,     0.00000,     0.00000,    np.inf],
            [10,  1,     0.00000,     0.00000,    np.inf],
            [10,  2,     0.00000,     0.00000,    np.inf],
            [10,  9,     0.00000,     0.00000,    np.inf],
            [10, 10,     0.00000,     5.79655,    np.inf],
            [10, 11,     0.00000,     1.54919,    np.inf],
            [11,  1,     0.00000,     0.00000,    np.inf],
            [11,  2,     0.00000,     0.00000,    np.inf],
            [11,  3,     0.00000,     0.00000,    np.inf],
            [11, 10,     0.00000,    -1.54919,    np.inf],
            [11, 11,     0.00000,     4.64758,    np.inf],
            [11, 12,     0.00000,     0.00000,    np.inf],
            [12,  2,     0.00000,     0.00000,    np.inf],
            [12,  3,     0.00000,     0.00000,    np.inf],
            [12, 11,     0.00000,     0.00000,    np.inf],
            [12, 12,     0.00000,     0.00000,    np.inf],
            [13, 13,     0.00000,     5.79655,    np.inf],
            [13, 14,     0.00000,     1.54919,    np.inf],
            [13, 21,     0.00000,     0.00000,    np.inf],
            [13, 22,     0.00000,     0.00000,    np.inf],
            [13, 23,     0.00000,     0.00000,    np.inf],
            [14, 13,     0.00000,    -1.54919,    np.inf],
            [14, 14,     0.00000,     4.64758,    np.inf],
            [14, 15,     0.00000,     0.00000,    np.inf],
            [14, 22,     0.00000,     0.00000,    np.inf],
            [14, 23,     0.00000,     0.00000,    np.inf],
            [14, 24,     0.00000,     0.00000,    np.inf],
            [15, 14,     0.00000,     0.00000,    np.inf],
            [15, 15,     0.00000,     0.00000,    np.inf],
            [15, 23,     0.00000,     0.00000,    np.inf],
            [15, 24,     0.00000,     0.00000,    np.inf],
            [16, 16,     0.20091,     9.62140,    np.inf],
            [16, 17,     0.03118,     1.85164,    np.inf],
            [17, 16,    -0.02611,    -1.85164,    np.inf],
            [17, 17,    -0.00255,     8.28079,    np.inf],
            [17, 18,     0.00517,     0.00000,    np.inf],
            [18, 17,     0.01191,     0.00000,    np.inf],
            [18, 18,     0.00522,     2.58199,    np.inf],
            [18, 19,     0.00326,     1.15470,    np.inf],
            [19, 18,     0.01290,    -1.15470,    np.inf],
            [19, 19,    -0.00761,     1.63299,    np.inf],
            [20, 20,     0.00000,    13.98412,    np.inf],
            [20, 21,     0.00000,     2.10819,    np.inf],
            [21, 13,     0.00000,     0.00000,    np.inf],
            [21, 20,     0.00000,    -2.10819,    np.inf],
            [21, 21,     0.00000,    12.47219,    np.inf],
            [21, 22,     0.00000,     0.00000,    np.inf],
            [22, 13,     0.00000,     0.00000,    np.inf],
            [22, 14,     0.00000,     0.00000,    np.inf],
            [22, 21,     0.00000,     0.00000,    np.inf],
            [22, 22,     0.00000,     5.79655,    np.inf],
            [22, 23,     0.00000,     1.54919,    np.inf],
            [23, 13,     0.00000,     0.00000,    np.inf],
            [23, 14,     0.00000,     0.00000,    np.inf],
            [23, 15,     0.00000,     0.00000,    np.inf],
            [23, 22,     0.00000,    -1.54919,    np.inf],
            [23, 23,     0.00000,     4.64758,    np.inf],
            [23, 24,     0.00000,     0.00000,    np.inf],
            [24, 14,     0.00000,     0.00000,    np.inf],
            [24, 15,     0.00000,     0.00000,    np.inf],
            [24, 23,     0.00000,     0.00000,    np.inf],
            [24, 24,     0.00000,     0.00000,    np.inf],
        ],
        dtype = np.float32,
    )
    expected_412210 = np.array(
        [
            [1,  1,     0.00000,     5.79655,    np.inf],
            [1,  2,     0.00000,     1.54919,    np.inf],
            [1,  9,     0.00000,     0.00000,    np.inf],
            [1, 10,     0.00000,     0.00000,    np.inf],
            [1, 11,     0.00000,     0.00000,    np.inf],
            [2,  1,     0.00000,    -1.54919,    np.inf],
            [2,  2,     0.00000,     4.64758,    np.inf],
            [2,  3,     0.00000,     0.00000,    np.inf],
            [2, 10,     0.00000,     0.00000,    np.inf],
            [2, 11,     0.00000,     0.00000,    np.inf],
            [2, 12,     0.00000,     0.00000,    np.inf],
            [3,  2,     0.00000,     0.00000,    np.inf],
            [3,  3,     0.00000,     0.00000,    np.inf],
            [3, 11,     0.00000,     0.00000,    np.inf],
            [3, 12,     0.00000,     0.00000,    np.inf],
            [4,  4,     0.08419,     9.62140,    np.inf],
            [4,  5,    -0.02409,     1.85164,    np.inf],
            [5,  4,     0.00710,    -1.85164,    np.inf],
            [5,  5,    -0.00525,     8.28079,    np.inf],
            [5,  6,    -0.00384,     0.00000,    np.inf],
            [6,  5,     0.01076,     0.00000,    np.inf],
            [6,  6,    -0.00617,     2.58199,    np.inf],
            [6,  7,     0.00664,     1.15470,    np.inf],
            [7,  6,     0.00229,    -1.15470,    np.inf],
            [7,  7,    -0.00185,     1.63299,    np.inf],
            [8,  8,     0.00000,    13.98412,    np.inf],
            [8,  9,     0.00000,     2.10819,    np.inf],
            [9,  1,     0.00000,     0.00000,    np.inf],
            [9,  8,     0.00000,    -2.10819,    np.inf],
            [9,  9,     0.00000,    12.47219,    np.inf],
            [9, 10,     0.00000,     0.00000,    np.inf],
            [10,  1,     0.00000,     0.00000,    np.inf],
            [10,  2,     0.00000,     0.00000,    np.inf],
            [10,  9,     0.00000,     0.00000,    np.inf],
            [10, 10,     0.00000,     5.79655,    np.inf],
            [10, 11,     0.00000,     1.54919,    np.inf],
            [11,  1,     0.00000,     0.00000,    np.inf],
            [11,  2,     0.00000,     0.00000,    np.inf],
            [11,  3,     0.00000,     0.00000,    np.inf],
            [11, 10,     0.00000,    -1.54919,    np.inf],
            [11, 11,     0.00000,     4.64758,    np.inf],
            [11, 12,     0.00000,     0.00000,    np.inf],
            [12,  2,     0.00000,     0.00000,    np.inf],
            [12,  3,     0.00000,     0.00000,    np.inf],
            [12, 11,     0.00000,     0.00000,    np.inf],
            [12, 12,     0.00000,     0.00000,    np.inf],
            [13, 13,     0.00000,     5.79655,    np.inf],
            [13, 14,     0.00000,     1.54919,    np.inf],
            [13, 21,     0.00000,     0.00000,    np.inf],
            [13, 22,     0.00000,     0.00000,    np.inf],
            [13, 23,     0.00000,     0.00000,    np.inf],
            [14, 13,     0.00000,    -1.54919,    np.inf],
            [14, 14,     0.00000,     4.64758,    np.inf],
            [14, 15,     0.00000,     0.00000,    np.inf],
            [14, 22,     0.00000,     0.00000,    np.inf],
            [14, 23,     0.00000,     0.00000,    np.inf],
            [14, 24,     0.00000,     0.00000,    np.inf],
            [15, 14,     0.00000,     0.00000,    np.inf],
            [15, 15,     0.00000,     0.00000,    np.inf],
            [15, 23,     0.00000,     0.00000,    np.inf],
            [15, 24,     0.00000,     0.00000,    np.inf],
            [16, 16,    -0.07841,     9.62140,    np.inf],
            [16, 17,    -0.01426,     1.85164,    np.inf],
            [17, 16,     0.01960,    -1.85164,    np.inf],
            [17, 17,     0.01798,     8.28079,    np.inf],
            [17, 18,     0.01551,     0.00000,    np.inf],
            [18, 17,    -0.01118,     0.00000,    np.inf],
            [18, 18,    -0.03065,     2.58199,    np.inf],
            [18, 19,    -0.00207,     1.15470,    np.inf],
            [19, 18,     0.00867,    -1.15470,    np.inf],
            [19, 19,    -0.01003,     1.63299,    np.inf],
            [20, 20,     0.00000,    13.98412,    np.inf],
            [20, 21,     0.00000,     2.10819,    np.inf],
            [21, 13,     0.00000,     0.00000,    np.inf],
            [21, 20,     0.00000,    -2.10819,    np.inf],
            [21, 21,     0.00000,    12.47219,    np.inf],
            [21, 22,     0.00000,     0.00000,    np.inf],
            [22, 13,     0.00000,     0.00000,    np.inf],
            [22, 14,     0.00000,     0.00000,    np.inf],
            [22, 21,     0.00000,     0.00000,    np.inf],
            [22, 22,     0.00000,     5.79655,    np.inf],
            [22, 23,     0.00000,     1.54919,    np.inf],
            [23, 13,     0.00000,     0.00000,    np.inf],
            [23, 14,     0.00000,     0.00000,    np.inf],
            [23, 15,     0.00000,     0.00000,    np.inf],
            [23, 22,     0.00000,    -1.54919,    np.inf],
            [23, 23,     0.00000,     4.64758,    np.inf],
            [23, 24,     0.00000,     0.00000,    np.inf],
            [24, 14,     0.00000,     0.00000,    np.inf],
            [24, 15,     0.00000,     0.00000,    np.inf],
            [24, 23,     0.00000,     0.00000,    np.inf],
            [24, 24,     0.00000,     0.00000,    np.inf],
        ],
        dtype = np.float32,
    )    

    expected_S_210410 = [
        1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000,
        0.00000, 0.00000, 0.00000, 0.00000, 1.22474, 0.00000, 0.00000, 1.60357,
        -1.85164, 1.85164,-1.03510, 0.00000, 0.00000, 1.29099,-1.15470, 1.15470,
        -0.40825, 1.74801,-2.10819, 0.00000, 2.10819,-1.24722, 0.00000, 0.00000,
        0.00000, 0.00000, 1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,
        -0.77460, 0.00000, 0.00000, 0.00000, 0.00000, 1.22474, 1.44914,-1.54919,
        0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000, 0.00000, 0.00000,
        0.00000, 0.00000, 1.22474, 0.00000, 0.00000, 1.60357,-1.85164, 1.85164,
        -1.03510, 0.00000, 0.00000, 1.29099,-1.15470, 1.15470,-0.40825, 1.74801,
        -2.10819, 0.00000, 2.10819,-1.24722, 0.00000, 0.00000, 0.00000, 0.00000,
        1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000,
        0.00000, 0.00000, 0.00000, 1.22474,
    ]

    expected_S_210411 = [
        1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000,
        0.00000, 0.00000, 0.00000, 0.00000, 1.22474, 0.00000, 0.00000, 1.60357,
        -1.85164, 1.85164,-1.03510, 0.00000, 0.00000, 1.29099,-1.15470, 1.15470,
        -0.40825, 1.74801,-2.10819, 0.00000, 2.10819,-1.24722, 0.00000, 0.00000,
        0.00000, 0.00000, 1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,
        -0.77460, 0.00000, 0.00000, 0.00000, 0.00000, 1.22474, 1.44914,-1.54919,
        0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000, 0.00000, 0.00000,
        0.00000, 0.00000, 1.22474, 0.00000, 0.00000, 1.60357,-1.85164, 1.85164,
        -1.03510, 0.00000, 0.00000, 1.29099,-1.15470, 1.15470,-0.40825, 1.74801,
        -2.10819, 0.00000, 2.10819,-1.24722, 0.00000, 0.00000, 0.00000, 0.00000,
        1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000,
        0.00000, 0.00000, 0.00000, 1.22474,
    ]

    expected_S_412210 = [
        1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000,
        0.00000, 0.00000, 0.00000, 0.00000, 1.22474, 0.00000, 0.00000, 1.60357,
        -1.85164, 1.85164,-1.03510, 0.00000, 0.00000, 1.29099,-1.15470, 1.15470,
        -0.40825, 1.74801,-2.10819, 0.00000, 2.10819,-1.24722, 0.00000, 0.00000,
        0.00000, 0.00000, 1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,
        -0.77460, 0.00000, 0.00000, 0.00000, 0.00000, 1.22474, 1.44914,-1.54919,
        0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000, 0.00000, 0.00000,
        0.00000, 0.00000, 1.22474, 0.00000, 0.00000, 1.60357,-1.85164, 1.85164,
        -1.03510, 0.00000, 0.00000, 1.29099,-1.15470, 1.15470,-0.40825, 1.74801,
        -2.10819, 0.00000, 2.10819,-1.24722, 0.00000, 0.00000, 0.00000, 0.00000,
        1.44914,-1.54919, 0.00000, 0.00000, 0.00000, 1.54919,-0.77460, 0.00000,
        0.00000, 0.00000, 0.00000, 1.22474,
    ]

    expected_210410[:, 0] -= 1
    expected_210410[:, 1] -= 1
    expected_210411[:, 0] -= 1
    expected_210411[:, 1] -= 1
    expected_412210[:, 0] -= 1
    expected_412210[:, 1] -= 1
    
    assert expected_keys == list(obtd_dict.keys())
    assert obtd_dict[expected_keys[3]].shape == (92, 5, 1)
    assert obtd_dict[expected_keys[4]].shape == (92, 5, 2)
    for key in expected_keys[5:]: assert obtd_dict[key].shape == (92, 5), key
    for i in [5, 7, 9]: assert np.all(obtd_dict[expected_keys[i]] == obtd_dict[expected_keys[i+1]])

    for expected, i in zip([expected_210410, expected_210411, expected_412210], [5, 7, 9]):
        assert np.all(expected == obtd_dict[(expected_keys[i])]), i

    _load_obtd(
        path = pkg_resources.resource_filename('kshell_utilities', 'test_files/obtd_test/OBTD_S_V50_GCLSTsdpfsdgix5pn_j2p_V50_GCLSTsdpfsdgix5pn_j4p.txt'),
        obtd_dict = obtd_dict,
        level_dict = level_dict,
    )

    expected_210410[:, 4] = expected_S_210410
    expected_210411[:, 4] = expected_S_210411
    expected_412210[:, 4] = expected_S_412210

    for i in [5, 7, 9]: assert np.all(obtd_dict[expected_keys[i]] == obtd_dict[expected_keys[i+1]])

    for expected, i in zip([expected_210410, expected_210411, expected_412210], [5, 7, 9]):
        assert np.all(expected == obtd_dict[(expected_keys[i])]), i
